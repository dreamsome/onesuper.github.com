---
layout: post
title: "当人们谈 C 语言时，他们谈些什么"
category: technium
tags: [C, Lisp]
---

人们在说到 Java 的时候，说的其实是语言本身、JVM、各种各样的 API，以及数也数不清的框架。C 语言也是如此，但因为 C 语言和操作系统之间的结合更为紧密，所以当人们在谈 C 语言的时候，谈的变成了下面这三样：C 语言的语法（这部分的内容其实是最少的，国人写的 C 语言的教材只关注这部分），操作系统，和 /usr/lib 下的那些动态链接库。


所有编程语言的语法看起来都差不多，但是那些少数看起来不一样的地方，却造成了本质的区别，它充分体现了程序员看待世界的方法。


### 语言的区别

如果要实现一个复杂数据结构，比如递归定义的树：


* C 程序员想到的是在一个 struct 里定义一个 struct 指针。
* Java 和 C# 的拥趸想的是在对象里面保留一个对这个对象的引用。
* Lisp程序员说：“不就是在 tree 里定义一个 tree 呗，tree 就是一个 list”。


这就是区别。Lisp 程序员站在了编程世界的最高层，他们在编程时可以更贴近现实世界去思考。而 C 程序员始终站在机器的角度，我们知道指针不过就是一个存放地址的变量，换句话讲 C 程序员的眼睛里都是一个个的“地址”。


而 Java 和 C++ 之类的面向对象语言都是建立在 C 的基础上（C++ 为了改进 C，Java 为了改进 C++），所以没有根本的区别，对象的引用仍旧是一个地址，只不过在 Java 中你不能像指针变量那样对它进行自加操作，释放内存的工作也可以交给 gc。

### 正交性

人们在设计语言时一个很重要的原则就是功能的“正交性”，即用更少的特性，完成更多的功能，语言本身越小越好，而把功能放到库里去扩展，这样编译器就能更加简洁，C 语言就是这么做的，C 语言没有 bool 类型，在 C 语言最早的版本中甚至没有枚举类型（enum），但是同样可以写出 Unix 这样精良的代码，这说明 C 语言的大部分功能都是正交的，比如用 char 可以取代 bool，用宏定义一样也可以代替 enum（但还不够正交，从函数式编程的角度看，表达式和函数这两个 C 语言的核心功能其实是最大的重复）。而 Java 虽然有更强的表达能力，但是付出的代价是语言本身就变得繁琐了（语法糖），如果语言在一开始设计的时候就没有考虑到这一点，而是拼命地加入各种特性，那么在发展的过程中就没有办法很好扩展，这在软件工程里有个专门的名字，叫“过早优化”。


Paul Graham 在《黑客与画家》中的的《一百年后人类怎样编程》这篇文章中指出：


> 很多数据结构存在的原因都与计算机的速度有关。比如，今天的许多语言都同时有字符串和列表。从语义上看，字符串或多或少可以理解成列表的一个子集，其中的每一个元素都是字符。那么，为什么还需要把字符串单列为一种数据类型呢？完全可以不这么做。只是为了提高效率，所以字符串才会存在。但是，这种以加快运行速度为目的、却使得编程语言的语义大大复杂的行为，很不可取。编程语言设置字符串似乎就是一个过早优化的例子。


要知道 C 语言就没有 String 这种类型，而是以字符数组形式呈现的，string.h 是 C++ 才有的，这在 Paul 看来就是多此一举。


在 Python 的最新版本 Python3 中取消了 print 关键字，彻底沦为一个函数 print()，同样说明了这个道理。虽然这会让很多 Python2的程序无法运行，但从语言的角度来看却是一种进步。


如果要搞明白指针和数组的区别，除了要知道什么是左值，什么是右值，还得知道赋值操作的时候机器到底干了哪些事情？换句话讲，必须从机器的层面上理解上了解语句的执行过程。这是任何国产的 C 语言教材无法告诉你的。如果在初学 C 语言的过程中始终都是在 IDE 下傻瓜式编程，又怎么会理解编译和链接期间都干了些什么事呢？唯一的方法就是找一个 \*nix 系统，然后用 cc 和 ld 编译链接一遍，琢磨那些选项卡加和不加有啥区别，写一个 Makefile，思索一下这中间经历了哪些步骤，而不是只追求语法上的正确。只有把自己放到操作系统的层面上，这样才能理解程序运行的原理，并且编写出和操作系统紧密结合的程序。


### C 语言为什么难？

学习 C 语言 80% 的时间其实是花在了学习指针上，而学习指针的过程中基本都在学习指针的声明语句怎么读。


C 语言之所以看起来复杂，并非人们常说的“指针操作很容易出错”（这对优秀的 C 程序员来说根本算不上问题），而是因为引入了指针运算符 \*（这玩意不但可以表示指针变量，还表示乘法运算，甚至是注释符的一部分），导致算符的优先表达到了根本无法记忆的地步，加上时左时右的结合顺序，于是程序的可读性就变差了，这便是 IOCCC 发扬光大的根本原因。


当然另一个原因就是 C 语言的自由花括号，它同样催生了一大批丑陋的代码，C 的面向对象版本 C++ 很自然地沿用了这种语法，而“致力于改进 C++ 身上一些缺陷”的 Java 也是如此。Python 通过强制编程者在写完一句语句时换行很好地解决了这个问题，谁让 Pythonic 崇尚“做事的方法只有一种”呢？


正所谓英雄所见略同，对黑客来讲也大抵如此，在 K&R 的《C语言程序设计》和《C专家编程》两本书中都以展示一个“分析声明的程序”（类似于一个解释器）来帮助理解读者理解 C 语言尤其是指针的声明，因为他们都懂得实践的重要性。
